// This Pine Scriptâ„¢ source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© XAUUSD Smart Money Concepts Trading Strategy
// Version 7.0 - Dynamic Position Sizing & Advanced Win Rate Optimization
// Proper risk-based lot sizing, comprehensive filtering system

//@version=6
strategy("XAUUSD SMC Strategy v7",
     overlay = true,
     pyramiding = 0,
     initial_capital = 100000,
     default_qty_type = strategy.percent_of_equity,
     default_qty_value = 100,
     commission_type = strategy.commission.cash_per_order,
     commission_value = 7,
     slippage = 3,
     process_orders_on_close = false,
     calc_on_every_tick = true,
     max_boxes_count = 500,
     max_lines_count = 500,
     max_labels_count = 500,
     use_bar_magnifier = true)

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                                                                                                            â•‘
// â•‘                              â˜…â˜…â˜… CONTROL CENTER v7.0 â˜…â˜…â˜…                                                   â•‘
// â•‘                                                                                                            â•‘
// â•‘   COMPREHENSIVE PARAMETER GUIDE                                                                            â•‘
// â•‘   Every parameter is explained with its effect on win rate and profitability                               â•‘
// â•‘                                                                                                            â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚ SECTION A: DYNAMIC POSITION SIZING (CRITICAL - FIXES LOT SIZE ISSUE)                                       â”‚
// â”‚                                                                                                            â”‚
// â”‚ Position size is calculated as: Risk$ / (SL_Distance Ã— Point_Value)                                        â”‚
// â”‚ This ensures you risk exactly 1% regardless of stop loss distance                                          â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

i_accountSize = input.float(100000, "ğŸ’° Account Size ($)",
     minval = 1000, step = 1000,
     group = "A. DYNAMIC POSITION SIZING",
     tooltip = "YOUR ACTUAL TRADING ACCOUNT SIZE\n\n" +
               "This is the base for all risk calculations.\n" +
               "Position size = (Account Ã— Risk%) Ã· (SL_Pips Ã— Pip_Value)\n\n" +
               "Example: $100,000 account, 1% risk, 100 pip SL, $10/pip:\n" +
               "Position = ($100,000 Ã— 0.01) Ã· (100 Ã— $10) = 1.0 lot")

i_riskPercent = input.float(1.0, "âš ï¸ Risk Per Trade (%)",
     minval = 0.25, maxval = 5.0, step = 0.25,
     group = "A. DYNAMIC POSITION SIZING",
     tooltip = "PERCENTAGE OF ACCOUNT RISKED PER TRADE\n\n" +
               "â–º 0.5% = Very Conservative ($500 risk on $100k)\n" +
               "â–º 1.0% = Standard/Recommended ($1,000 risk on $100k)\n" +
               "â–º 2.0% = Aggressive ($2,000 risk on $100k)\n\n" +
               "WIN RATE IMPACT: Lower risk doesn't change win rate,\n" +
               "but protects capital during losing streaks.")

i_maxRiskDollars = input.float(1000, "ğŸ›‘ Maximum Risk Per Trade ($)",
     minval = 100, maxval = 10000, step = 100,
     group = "A. DYNAMIC POSITION SIZING",
     tooltip = "HARD CAP ON DOLLAR RISK\n\n" +
               "Even if % risk calculates higher, this caps it.\n" +
               "Safety net for large accounts.\n\n" +
               "Example: 1% of $500,000 = $5,000, but cap at $1,000")

i_contractSize = input.float(100, "ğŸ“Š Contract Size (oz per lot)",
     minval = 1, maxval = 100, step = 1,
     group = "A. DYNAMIC POSITION SIZING",
     tooltip = "OUNCES OF GOLD PER STANDARD LOT\n\n" +
               "â–º Standard Lot = 100 oz\n" +
               "â–º Mini Lot = 10 oz\n" +
               "â–º Micro Lot = 1 oz\n\n" +
               "Check your broker's contract specifications.\n" +
               "Most brokers use 100 oz per standard lot for XAUUSD.")

i_minLots = input.float(0.01, "Minimum Lot Size",
     minval = 0.01, maxval = 1.0, step = 0.01,
     group = "A. DYNAMIC POSITION SIZING",
     tooltip = "Smallest position your broker allows.\n" +
               "Usually 0.01 for most brokers.")

i_maxLots = input.float(10.0, "Maximum Lot Size",
     minval = 1.0, maxval = 100.0, step = 1.0,
     group = "A. DYNAMIC POSITION SIZING",
     tooltip = "Largest position allowed per trade.\n" +
               "Prevents oversized positions from calculation errors.")

// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚ SECTION B: STOP LOSS PLACEMENT                                                                             â”‚
// â”‚                                                                                                            â”‚
// â”‚ WHERE the stop is placed determines both risk AND win rate                                                 â”‚
// â”‚ Too tight = stopped out before trade develops (low win rate)                                               â”‚
// â”‚ Too wide = small position size, big losses when wrong                                                      â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

i_slMethod = input.string("Structure + Sweep Buffer", "Stop Loss Method",
     options = ["Structure + Sweep Buffer", "ATR Multiple", "Fixed Pips", "Order Block Based"],
     group = "B. STOP LOSS PLACEMENT",
     tooltip = "HOW INITIAL STOP LOSS IS CALCULATED\n\n" +
               "â–º STRUCTURE + SWEEP BUFFER (Best for win rate):\n" +
               "   Places SL below key swing low + buffer for sweeps\n" +
               "   Respects market structure, survives manipulation\n\n" +
               "â–º ATR MULTIPLE:\n" +
               "   SL = Entry Â± (ATR Ã— Multiplier)\n" +
               "   Adapts to volatility but ignores structure\n\n" +
               "â–º FIXED PIPS:\n" +
               "   Static distance regardless of market conditions\n" +
               "   Simple but may be too tight or too wide\n\n" +
               "â–º ORDER BLOCK BASED:\n" +
               "   SL beyond the OB that triggered entry")

i_structureLookback = input.int(30, "Structure Lookback (bars)",
     minval = 10, maxval = 100, step = 5,
     group = "B. STOP LOSS PLACEMENT",
     tooltip = "BARS TO LOOK BACK FOR KEY SUPPORT/RESISTANCE\n\n" +
               "â–º HIGHER (40-60) = Finds major swing levels\n" +
               "   - Wider stops, more protection\n" +
               "   - Higher win rate (levels hold better)\n" +
               "   - Smaller position size\n\n" +
               "â–º LOWER (15-25) = Uses recent minor swings\n" +
               "   - Tighter stops, larger positions\n" +
               "   - Lower win rate (levels break easier)\n\n" +
               "WIN RATE TIP: Start at 30-40 bars")

i_sweepBuffer = input.float(0.8, "Liquidity Sweep Buffer (ATR mult)",
     minval = 0.2, maxval = 2.0, step = 0.1,
     group = "B. STOP LOSS PLACEMENT",
     tooltip = "EXTRA BUFFER BEYOND STRUCTURE FOR BANK SWEEPS\n\n" +
               "Institutions sweep obvious stop levels before reversing.\n" +
               "This buffer places your stop BEYOND typical sweep depth.\n\n" +
               "â–º HIGHER (1.0-1.5) = Maximum sweep protection\n" +
               "   - Very few false stop-outs\n" +
               "   - Higher win rate\n" +
               "   - Smaller position size\n\n" +
               "â–º LOWER (0.3-0.5) = Minimal buffer\n" +
               "   - More stop-outs from sweeps\n" +
               "   - Lower win rate\n" +
               "   - Larger position size\n\n" +
               "WIN RATE TIP: Use 0.7-1.0 for XAUUSD")

i_atrMult = input.float(2.5, "ATR Multiplier (if ATR method)",
     minval = 1.0, maxval = 5.0, step = 0.25,
     group = "B. STOP LOSS PLACEMENT",
     tooltip = "ATR multiplier for ATR-based stop loss.\n\n" +
               "â–º HIGHER = Wider stops, higher win rate, smaller size\n" +
               "â–º LOWER = Tighter stops, lower win rate, larger size")

i_fixedSLPips = input.float(100, "Fixed SL (pips, if Fixed method)",
     minval = 30, maxval = 300, step = 10,
     group = "B. STOP LOSS PLACEMENT",
     tooltip = "Static pip distance for Fixed Pips method.\n\n" +
               "For XAUUSD, 1 pip = $0.10 price movement")

i_minSLPips = input.float(50, "Minimum SL Distance (pips)",
     minval = 20, maxval = 150, step = 10,
     group = "B. STOP LOSS PLACEMENT",
     tooltip = "FLOOR FOR STOP LOSS DISTANCE\n\n" +
               "Prevents stops that are too tight.\n" +
               "Even if structure suggests 30 pips, minimum enforces 50.\n\n" +
               "WIN RATE TIP: 50-75 pips minimum for XAUUSD 15m/1H")

i_maxSLPips = input.float(150, "Maximum SL Distance (pips)",
     minval = 75, maxval = 400, step = 25,
     group = "B. STOP LOSS PLACEMENT",
     tooltip = "CEILING FOR STOP LOSS DISTANCE\n\n" +
               "Prevents excessively wide stops.\n" +
               "Keeps position size reasonable.\n\n" +
               "If structure suggests 200 pips but max is 150,\n" +
               "SL will be capped at 150 pips.")

// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚ SECTION C: RSI FILTER (WIN RATE OPTIMIZER)                                                                 â”‚
// â”‚                                                                                                            â”‚
// â”‚ RSI helps avoid entries at exhaustion points                                                               â”‚
// â”‚ Don't buy when overbought, don't sell when oversold                                                        â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

i_useRSI = input.bool(true, "âœ… Enable RSI Filter",
     group = "C. RSI FILTER",
     tooltip = "USE RSI TO FILTER ENTRIES\n\n" +
               "RSI measures momentum exhaustion.\n" +
               "Helps avoid buying tops and selling bottoms.\n\n" +
               "â–º ON = Higher win rate, fewer trades\n" +
               "â–º OFF = More trades, lower win rate")

i_rsiLength = input.int(14, "RSI Period",
     minval = 5, maxval = 30, step = 1,
     group = "C. RSI FILTER",
     tooltip = "Lookback period for RSI calculation.\n\n" +
               "â–º HIGHER (20-30) = Smoother, slower signals\n" +
               "â–º LOWER (7-10) = More reactive, faster signals")

i_rsiOBLevel = input.float(70, "RSI Overbought Level",
     minval = 60, maxval = 85, step = 5,
     group = "C. RSI FILTER",
     tooltip = "AVOID LONGS WHEN RSI ABOVE THIS LEVEL\n\n" +
               "High RSI = Price extended, likely to pull back.\n\n" +
               "â–º HIGHER (75-80) = Less restrictive, more long trades\n" +
               "â–º LOWER (65-70) = More restrictive, higher win rate\n\n" +
               "WIN RATE TIP: Use 70 to filter exhausted moves")

i_rsiOSLevel = input.float(30, "RSI Oversold Level",
     minval = 15, maxval = 40, step = 5,
     group = "C. RSI FILTER",
     tooltip = "AVOID SHORTS WHEN RSI BELOW THIS LEVEL\n\n" +
               "Low RSI = Price extended down, likely to bounce.\n\n" +
               "â–º LOWER (20-25) = Less restrictive, more short trades\n" +
               "â–º HIGHER (30-35) = More restrictive, higher win rate")

i_rsiMidMin = input.float(40, "RSI Sweet Spot Min",
     minval = 30, maxval = 50, step = 5,
     group = "C. RSI FILTER",
     tooltip = "Minimum RSI for 'neutral zone' entries.\n\n" +
               "Entries in 40-60 zone often have best follow-through.")

i_rsiMidMax = input.float(60, "RSI Sweet Spot Max",
     minval = 50, maxval = 70, step = 5,
     group = "C. RSI FILTER",
     tooltip = "Maximum RSI for 'neutral zone' entries.\n\n" +
               "Ideal: Longs with RSI 40-55, Shorts with RSI 45-60")

// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚ SECTION D: ADX TREND STRENGTH FILTER                                                                       â”‚
// â”‚                                                                                                            â”‚
// â”‚ ADX measures trend strength (not direction)                                                                â”‚
// â”‚ Higher ADX = Stronger trend = Better for trend-following entries                                           â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

i_useADX = input.bool(true, "âœ… Enable ADX Filter",
     group = "D. ADX TREND FILTER",
     tooltip = "USE ADX TO MEASURE TREND STRENGTH\n\n" +
               "ADX above threshold = Strong trend, good for entries\n" +
               "ADX below threshold = Choppy market, avoid entries\n\n" +
               "â–º ON = Filters out ranging markets, higher win rate\n" +
               "â–º OFF = Trades in all conditions")

i_adxLength = input.int(14, "ADX Period",
     minval = 7, maxval = 30, step = 1,
     group = "D. ADX TREND FILTER",
     tooltip = "Lookback period for ADX calculation.\n\n" +
               "Standard is 14.")

i_adxThreshold = input.float(20, "ADX Minimum Threshold",
     minval = 10, maxval = 40, step = 2,
     group = "D. ADX TREND FILTER",
     tooltip = "MINIMUM ADX TO ALLOW ENTRIES\n\n" +
               "â–º HIGHER (25-30) = Only strong trends, fewer trades, higher win rate\n" +
               "â–º LOWER (15-18) = More trades, includes weaker trends\n\n" +
               "WIN RATE TIP: Use 20-25 for XAUUSD")

i_adxMax = input.float(50, "ADX Maximum (optional)",
     minval = 30, maxval = 80, step = 5,
     group = "D. ADX TREND FILTER",
     tooltip = "AVOID ENTRIES WHEN ADX EXTREMELY HIGH\n\n" +
               "Very high ADX can mean trend exhaustion.\n" +
               "Set to 80 to effectively disable this check.")

// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚ SECTION E: VOLATILITY FILTER                                                                               â”‚
// â”‚                                                                                                            â”‚
// â”‚ Avoid trading when volatility is too low (no movement) or too high (unpredictable)                         â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

i_useVolFilter = input.bool(true, "âœ… Enable Volatility Filter",
     group = "E. VOLATILITY FILTER",
     tooltip = "FILTER BASED ON CURRENT VOLATILITY\n\n" +
               "â–º Low volatility = Tight ranges, fake breakouts\n" +
               "â–º High volatility = Unpredictable, large swings\n\n" +
               "â–º ON = Trade only in optimal volatility\n" +
               "â–º OFF = Trade all volatility conditions")

i_atrPeriod = input.int(14, "ATR Period",
     minval = 5, maxval = 50, step = 1,
     group = "E. VOLATILITY FILTER",
     tooltip = "Period for ATR (Average True Range) calculation.")

i_volLookback = input.int(100, "Volatility Comparison Period",
     minval = 50, maxval = 200, step = 10,
     group = "E. VOLATILITY FILTER",
     tooltip = "Bars to calculate average ATR for comparison.\n\n" +
               "Current ATR is compared to average ATR over this period.")

i_minVolPercent = input.float(60, "Minimum Volatility (%)",
     minval = 30, maxval = 100, step = 10,
     group = "E. VOLATILITY FILTER",
     tooltip = "MINIMUM VOLATILITY VS AVERAGE\n\n" +
               "If current ATR < 60% of average, market is too quiet.\n\n" +
               "â–º HIGHER (70-80%) = Requires more active markets\n" +
               "â–º LOWER (40-50%) = Allows quieter conditions")

i_maxVolPercent = input.float(200, "Maximum Volatility (%)",
     minval = 120, maxval = 400, step = 20,
     group = "E. VOLATILITY FILTER",
     tooltip = "MAXIMUM VOLATILITY VS AVERAGE\n\n" +
               "If current ATR > 200% of average, market is too wild.\n\n" +
               "â–º LOWER (150%) = Avoids volatile periods\n" +
               "â–º HIGHER (300%) = Allows more volatile conditions")

// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚ SECTION F: PRICE ACTION CONFIRMATION                                                                       â”‚
// â”‚                                                                                                            â”‚
// â”‚ Require specific candle patterns before entry                                                              â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

i_usePAConfirm = input.bool(true, "âœ… Enable Price Action Filter",
     group = "F. PRICE ACTION",
     tooltip = "REQUIRE CONFIRMING CANDLE PATTERNS\n\n" +
               "â–º ON = Only enter on strong candle confirmation\n" +
               "â–º OFF = Enter without pattern confirmation")

i_paType = input.string("Strong Close", "Confirmation Type",
     options = ["Strong Close", "Engulfing", "Pin Bar", "Any Reversal"],
     group = "F. PRICE ACTION",
     tooltip = "TYPE OF CANDLE CONFIRMATION REQUIRED\n\n" +
               "â–º STRONG CLOSE:\n" +
               "   Candle closes in top 30% (longs) or bottom 30% (shorts)\n" +
               "   Shows conviction in direction\n\n" +
               "â–º ENGULFING:\n" +
               "   Current candle engulfs previous candle\n" +
               "   Strong reversal signal\n\n" +
               "â–º PIN BAR:\n" +
               "   Long wick rejection candle\n" +
               "   Shows price rejection at level\n\n" +
               "â–º ANY REVERSAL:\n" +
               "   Accepts any of the above patterns")

i_minCandleSize = input.float(0.3, "Min Candle Size (ATR mult)",
     minval = 0.1, maxval = 1.0, step = 0.1,
     group = "F. PRICE ACTION",
     tooltip = "MINIMUM CANDLE BODY SIZE FOR CONFIRMATION\n\n" +
               "Filters out weak, indecisive candles (dojis).\n\n" +
               "â–º HIGHER (0.5-0.7) = Only strong candles, fewer entries\n" +
               "â–º LOWER (0.2-0.3) = Smaller candles accepted")

// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚ SECTION G: MULTI-TIMEFRAME CONFIRMATION                                                                    â”‚
// â”‚                                                                                                            â”‚
// â”‚ Higher timeframe must agree with trade direction                                                           â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

i_useHTF = input.bool(true, "âœ… Enable HTF Alignment",
     group = "G. HIGHER TIMEFRAME",
     tooltip = "REQUIRE HIGHER TIMEFRAME TREND AGREEMENT\n\n" +
               "Only long when HTF bullish, only short when HTF bearish.\n\n" +
               "â–º ON = Trades with major trend, higher win rate\n" +
               "â–º OFF = Can counter-trend trade")

i_htfTimeframe = input.timeframe("240", "HTF Timeframe",
     group = "G. HIGHER TIMEFRAME",
     tooltip = "HIGHER TIMEFRAME FOR BIAS\n\n" +
               "â–º 60 = 1 Hour\n" +
               "â–º 240 = 4 Hour (recommended for 15m-1H entries)\n" +
               "â–º D = Daily\n\n" +
               "Should be 4-8x your entry timeframe.")

i_htfMALength = input.int(21, "HTF Trend MA Length",
     minval = 10, maxval = 50, step = 1,
     group = "G. HIGHER TIMEFRAME",
     tooltip = "Moving average length on HTF for trend determination.\n\n" +
               "Price above MA = Bullish bias\n" +
               "Price below MA = Bearish bias")

i_htfStrictness = input.string("Standard", "HTF Alignment Strictness",
     options = ["Loose", "Standard", "Strict"],
     group = "G. HIGHER TIMEFRAME",
     tooltip = "HOW STRICT THE HTF ALIGNMENT MUST BE\n\n" +
               "â–º LOOSE: HTF neutral allows any trade\n" +
               "â–º STANDARD: HTF must not oppose trade direction\n" +
               "â–º STRICT: HTF must actively confirm direction")

// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚ SECTION H: ORDER BLOCK QUALITY                                                                             â”‚
// â”‚                                                                                                            â”‚
// â”‚ Not all Order Blocks are equal - filter for quality                                                        â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

i_requireOB = input.bool(true, "âœ… Require Order Block Entry",
     group = "H. ORDER BLOCK QUALITY",
     tooltip = "ONLY ENTER AT ORDER BLOCKS\n\n" +
               "Order Blocks are institutional supply/demand zones.\n\n" +
               "â–º ON = Higher probability entries at OBs\n" +
               "â–º OFF = Can enter without OB (not recommended)")

i_obLookback = input.int(15, "OB Lookback (bars)",
     minval = 5, maxval = 50, step = 5,
     group = "H. ORDER BLOCK QUALITY",
     tooltip = "HOW OLD AN ORDER BLOCK CAN BE\n\n" +
               "â–º LOWER (10-15) = Only fresh OBs, more reliable\n" +
               "â–º HIGHER (25-40) = Older OBs valid, more entries")

i_obProximity = input.float(0.3, "OB Proximity (ATR)",
     minval = 0.1, maxval = 1.0, step = 0.1,
     group = "H. ORDER BLOCK QUALITY",
     tooltip = "HOW CLOSE PRICE MUST BE TO OB\n\n" +
               "â–º LOWER (0.2-0.3) = Must touch or be very close\n" +
               "   Higher win rate, entries at optimal levels\n\n" +
               "â–º HIGHER (0.5-0.7) = Can enter further from OB\n" +
               "   More entries but not at optimal levels")

i_obMinStrength = input.float(0.5, "OB Minimum Strength (ATR)",
     minval = 0.2, maxval = 1.5, step = 0.1,
     group = "H. ORDER BLOCK QUALITY",
     tooltip = "MINIMUM SIZE FOR VALID ORDER BLOCK\n\n" +
               "Measured as candle body size in ATR multiples.\n\n" +
               "â–º HIGHER (0.6-0.8) = Only strong OBs, fewer but better\n" +
               "â–º LOWER (0.3-0.4) = Weaker OBs included, more entries")

i_obRequireBreak = input.bool(true, "OB Must Break Structure",
     group = "H. ORDER BLOCK QUALITY",
     tooltip = "OB CANDLE MUST BREAK RECENT HIGH/LOW\n\n" +
               "True OBs create structure breaks.\n\n" +
               "â–º ON = Higher quality OBs only\n" +
               "â–º OFF = Any OB pattern qualifies")

// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚ SECTION I: TAKE PROFIT & PROFIT MANAGEMENT                                                                 â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

i_tp1RR = input.float(1.5, "TP1 Risk:Reward",
     minval = 0.5, maxval = 3.0, step = 0.25,
     group = "I. TAKE PROFIT",
     tooltip = "FIRST TAKE PROFIT TARGET\n\n" +
               "â–º 1.0 = 1:1 (TP at same distance as SL)\n" +
               "â–º 1.5 = 1.5:1 (50% more than risk)\n" +
               "â–º 2.0 = 2:1 (double the risk distance)")

i_tp2RR = input.float(2.5, "TP2 Risk:Reward",
     minval = 1.0, maxval = 5.0, step = 0.5,
     group = "I. TAKE PROFIT",
     tooltip = "SECOND/FINAL TAKE PROFIT TARGET\n\n" +
               "Where remaining position exits.")

i_tp1Percent = input.float(60, "TP1 Close Percentage (%)",
     minval = 30, maxval = 80, step = 10,
     group = "I. TAKE PROFIT",
     tooltip = "PORTION CLOSED AT TP1\n\n" +
               "â–º 60-70% = Lock majority at TP1, small runner\n" +
               "â–º 40-50% = Balanced partial and runner")

// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚ SECTION J: BREAKEVEN & TRAILING                                                                            â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

i_enableBE = input.bool(true, "Enable Breakeven",
     group = "J. BREAKEVEN & TRAILING",
     tooltip = "Move stop to entry after profit threshold.")

i_beActivation = input.float(1.0, "BE Activation (% profit)",
     minval = 0.5, maxval = 3.0, step = 0.25,
     group = "J. BREAKEVEN & TRAILING",
     tooltip = "PROFIT % BEFORE MOVING TO BREAKEVEN\n\n" +
               "â–º HIGHER = More room for trade to develop\n" +
               "â–º LOWER = Locks BE faster but more BE stop-outs")

i_bePlusPips = input.float(15, "BE Plus Pips",
     minval = 0, maxval = 50, step = 5,
     group = "J. BREAKEVEN & TRAILING",
     tooltip = "Extra pips profit locked at 'breakeven'.\n\n" +
               "15 means stop moves to Entry+15 pips.")

i_enableTrail = input.bool(true, "Enable Trailing Stop",
     group = "J. BREAKEVEN & TRAILING",
     tooltip = "Trail stop after BE to lock more profit.")

i_trailActivation = input.float(1.5, "Trail Activation (% profit)",
     minval = 0.5, maxval = 4.0, step = 0.25,
     group = "J. BREAKEVEN & TRAILING",
     tooltip = "Profit % before trailing begins.")

i_trailATR = input.float(1.5, "Trailing Distance (ATR)",
     minval = 0.5, maxval = 3.0, step = 0.25,
     group = "J. BREAKEVEN & TRAILING",
     tooltip = "Distance behind price for trailing stop.")

// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚ SECTION K: SESSION QUALITY FILTER                                                                          â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

i_useSession = input.bool(true, "âœ… Enable Session Filter",
     group = "K. SESSION FILTER",
     tooltip = "ONLY TRADE DURING HIGH-QUALITY SESSIONS\n\n" +
               "London and NY sessions have best liquidity.\n\n" +
               "â–º ON = Trade during optimal hours, higher win rate\n" +
               "â–º OFF = Trade 24/5")

i_sessionType = input.string("London + NY", "Session Selection",
     options = ["London Only", "NY Only", "London + NY", "London/NY Overlap", "All Sessions"],
     group = "K. SESSION FILTER",
     tooltip = "WHICH SESSIONS TO TRADE\n\n" +
               "â–º LONDON + NY = Best combination (3AM-5PM EST)\n" +
               "â–º OVERLAP = Peak liquidity (8AM-12PM EST)\n" +
               "â–º ALL = No session restriction")

// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚ SECTION L: DAY OF WEEK FILTER                                                                              â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

i_useDayFilter = input.bool(false, "Enable Day Filter",
     group = "L. DAY FILTER",
     tooltip = "Restrict trading to specific days.")

i_tradeMon = input.bool(true, "Monday", inline = "days", group = "L. DAY FILTER")
i_tradeTue = input.bool(true, "Tuesday", inline = "days", group = "L. DAY FILTER")
i_tradeWed = input.bool(true, "Wednesday", inline = "days", group = "L. DAY FILTER")
i_tradeThu = input.bool(true, "Thursday", inline = "days", group = "L. DAY FILTER")
i_tradeFri = input.bool(true, "Friday", inline = "days", group = "L. DAY FILTER")

// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚ SECTION M: TRADE DIRECTION                                                                                 â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

i_enableLongs = input.bool(true, "âœ… Enable Long Trades",
     group = "M. TRADE DIRECTION",
     tooltip = "Allow buy positions.")

i_enableShorts = input.bool(true, "âœ… Enable Short Trades",
     group = "M. TRADE DIRECTION",
     tooltip = "Allow sell positions.\n\n" +
               "TIP: If shorts have poor win rate, disable them.")

// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚ SECTION N: DRAWDOWN PROTECTION                                                                             â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

i_maxDrawdown = input.float(7.0, "Max Account Drawdown (%)",
     minval = 3.0, maxval = 25.0, step = 1.0,
     group = "N. PROTECTION",
     tooltip = "Stop trading when drawdown hits this level.")

i_maxDailyLoss = input.float(2.0, "Max Daily Loss (%)",
     minval = 1.0, maxval = 5.0, step = 0.5,
     group = "N. PROTECTION",
     tooltip = "Stop trading for day after this loss.")

i_maxDailyTrades = input.int(5, "Max Trades Per Day",
     minval = 1, maxval = 20, step = 1,
     group = "N. PROTECTION",
     tooltip = "Maximum trades allowed per day.")

// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚ SECTION O: VISUALS                                                                                         â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

i_showOB = input.bool(true, "Show Order Blocks", group = "O. VISUALS")
i_showSwings = input.bool(true, "Show Swing Points", group = "O. VISUALS")
i_showEntries = input.bool(true, "Show Entry Signals", group = "O. VISUALS")
i_showSLTP = input.bool(true, "Show SL/TP Lines", group = "O. VISUALS")
i_showTable = input.bool(true, "Show Info Table", group = "O. VISUALS")
i_showPosSize = input.bool(true, "Show Position Size", group = "O. VISUALS")
i_enableAlerts = input.bool(true, "Enable Alerts", group = "O. VISUALS")

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                                         CORE CALCULATIONS                                                  â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// --- ATR ---
atr = ta.atr(i_atrPeriod)
avgATR = ta.sma(atr, i_volLookback)

// --- Pip Calculations ---
// For XAUUSD: 1 pip = $0.10 price movement
pipSize = 0.1
priceToPips(float p) => p / pipSize
pipsToPrice(float p) => p * pipSize

// --- RSI ---
rsi = ta.rsi(close, i_rsiLength)

// --- ADX ---
[diPlus, diMinus, adxValue] = ta.dmi(i_adxLength, i_adxLength)

// --- Volatility Check ---
volRatio = (atr / avgATR) * 100
volOK = not i_useVolFilter or (volRatio >= i_minVolPercent and volRatio <= i_maxVolPercent)

// --- Account & Risk Tracking ---
var float peakEquity = strategy.initial_capital
var float dailyStartEquity = strategy.initial_capital
var int dailyTrades = 0

if strategy.equity > peakEquity
    peakEquity := strategy.equity

currentDD = (peakEquity - strategy.equity) / peakEquity * 100

newDay = ta.change(dayofweek) != 0
if newDay
    dailyStartEquity := strategy.equity
    dailyTrades := 0

dailyPnL = strategy.equity - dailyStartEquity
dailyLossPercent = dailyPnL < 0 ? math.abs(dailyPnL) / dailyStartEquity * 100 : 0

inMaxDD = currentDD >= i_maxDrawdown
inDailyLimit = dailyLossPercent >= i_maxDailyLoss
canTrade = not inMaxDD and not inDailyLimit and dailyTrades < i_maxDailyTrades

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                                         STRUCTURE ANALYSIS                                                 â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// --- Swing Detection ---
swingLen = 5
swingHigh = ta.pivothigh(high, swingLen, swingLen)
swingLow = ta.pivotlow(low, swingLen, swingLen)

// --- Key Structure Levels (for SL) ---
keyLow = ta.lowest(low, i_structureLookback)
keyHigh = ta.highest(high, i_structureLookback)

// --- Market Bias ---
trendMA = ta.sma(close, 50)
fastMA = ta.sma(close, 20)

var int bias = 0
if close > trendMA and fastMA > trendMA
    bias := 1
else if close < trendMA and fastMA < trendMA
    bias := -1
else
    bias := 0

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                                         HTF ANALYSIS                                                       â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

htfClose = request.security(syminfo.tickerid, i_htfTimeframe, close, lookahead = barmerge.lookahead_off)
htfMA = request.security(syminfo.tickerid, i_htfTimeframe, ta.sma(close, i_htfMALength), lookahead = barmerge.lookahead_off)

var int htfBias = 0
if htfClose > htfMA
    htfBias := 1
else if htfClose < htfMA
    htfBias := -1
else
    htfBias := 0

htfLongOK = switch i_htfStrictness
    "Loose" => htfBias >= 0
    "Standard" => htfBias >= 0
    "Strict" => htfBias == 1
    => true

htfShortOK = switch i_htfStrictness
    "Loose" => htfBias <= 0
    "Standard" => htfBias <= 0
    "Strict" => htfBias == -1
    => true

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                                         ORDER BLOCK DETECTION                                              â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

type OrderBlock
    float top
    float bottom
    int barIdx
    bool valid
    float strength

var array<OrderBlock> bullOBs = array.new<OrderBlock>()
var array<OrderBlock> bearOBs = array.new<OrderBlock>()

// Detect Bullish OB (last bearish candle before strong bullish move)
bullBody = close - open
bearBody = open - close
strongBullish = close > open and bullBody >= atr * i_obMinStrength
strongBearish = close < open and bearBody >= atr * i_obMinStrength
prevBearish = close[1] < open[1]
prevBullish = close[1] > open[1]

structureBreakUp = i_obRequireBreak ? high > ta.highest(high[1], 10) : true
structureBreakDown = i_obRequireBreak ? low < ta.lowest(low[1], 10) : true

bullishOB = strongBullish and prevBearish and structureBreakUp
bearishOB = strongBearish and prevBullish and structureBreakDown

if bullishOB
    newOB = OrderBlock.new(high[1], low[1], bar_index - 1, true, bullBody / atr)
    array.push(bullOBs, newOB)
    if array.size(bullOBs) > 20
        array.shift(bullOBs)

if bearishOB
    newOB = OrderBlock.new(high[1], low[1], bar_index - 1, true, bearBody / atr)
    array.push(bearOBs, newOB)
    if array.size(bearOBs) > 20
        array.shift(bearOBs)

// Check price at OB
checkBullOB() =>
    result = false
    obBot = float(na)
    if array.size(bullOBs) > 0
        for i = array.size(bullOBs) - 1 to 0
            ob = array.get(bullOBs, i)
            age = bar_index - ob.barIdx
            if ob.valid and age <= i_obLookback
                prox = atr * i_obProximity
                if low <= ob.top + prox and close >= ob.bottom - prox
                    result := true
                    obBot := ob.bottom
                    break
    [result, obBot]

checkBearOB() =>
    result = false
    obTop = float(na)
    if array.size(bearOBs) > 0
        for i = array.size(bearOBs) - 1 to 0
            ob = array.get(bearOBs, i)
            age = bar_index - ob.barIdx
            if ob.valid and age <= i_obLookback
                prox = atr * i_obProximity
                if high >= ob.bottom - prox and close <= ob.top + prox
                    result := true
                    obTop := ob.top
                    break
    [result, obTop]

[atBullOB, bullOBBot] = checkBullOB()
[atBearOB, bearOBTop] = checkBearOB()

// Invalidate mitigated OBs
if array.size(bullOBs) > 0
    for i = array.size(bullOBs) - 1 to 0
        ob = array.get(bullOBs, i)
        if low < ob.bottom
            ob.valid := false

if array.size(bearOBs) > 0
    for i = array.size(bearOBs) - 1 to 0
        ob = array.get(bearOBs, i)
        if high > ob.top
            ob.valid := false

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                                         FILTERS                                                            â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// --- RSI Filter ---
rsiLongOK = not i_useRSI or (rsi < i_rsiOBLevel and rsi > i_rsiOSLevel)
rsiShortOK = not i_useRSI or (rsi > i_rsiOSLevel and rsi < i_rsiOBLevel)

// Better: Use sweet spot
rsiSweetLong = not i_useRSI or (rsi >= i_rsiOSLevel and rsi <= i_rsiMidMax)
rsiSweetShort = not i_useRSI or (rsi >= i_rsiMidMin and rsi <= i_rsiOBLevel)

// --- ADX Filter ---
adxOK = not i_useADX or (adxValue >= i_adxThreshold and adxValue <= i_adxMax)

// --- Price Action Confirmation ---
candleBody = math.abs(close - open)
candleRange = high - low
strongClose = candleBody >= atr * i_minCandleSize

bullishClose = close > open and close > (high + low) / 2 and (close - low) > (high - close)
bearishClose = close < open and close < (high + low) / 2 and (high - close) > (close - low)

// Engulfing
bullEngulf = close > open and close > high[1] and open < low[1]
bearEngulf = close < open and close < low[1] and open > high[1]

// Pin Bar (rejection)
bullPin = (high - low) > atr * 0.5 and (open - low) > candleRange * 0.6 and close > open
bearPin = (high - low) > atr * 0.5 and (high - open) > candleRange * 0.6 and close < open

paLongOK = not i_usePAConfirm or switch i_paType
    "Strong Close" => bullishClose and strongClose
    "Engulfing" => bullEngulf
    "Pin Bar" => bullPin
    "Any Reversal" => bullishClose or bullEngulf or bullPin
    => true

paShortOK = not i_usePAConfirm or switch i_paType
    "Strong Close" => bearishClose and strongClose
    "Engulfing" => bearEngulf
    "Pin Bar" => bearPin
    "Any Reversal" => bearishClose or bearEngulf or bearPin
    => true

// --- Session Filter ---
hour_est = hour(time, "America/New_York")

londonSession = hour_est >= 3 and hour_est < 12
nySession = hour_est >= 8 and hour_est < 17
overlapSession = hour_est >= 8 and hour_est < 12

sessionOK = not i_useSession or switch i_sessionType
    "London Only" => londonSession
    "NY Only" => nySession
    "London + NY" => londonSession or nySession
    "London/NY Overlap" => overlapSession
    "All Sessions" => true
    => true

// --- Day Filter ---
dow = dayofweek(time)
dayOK = not i_useDayFilter or (
     (dow == dayofweek.monday and i_tradeMon) or
     (dow == dayofweek.tuesday and i_tradeTue) or
     (dow == dayofweek.wednesday and i_tradeWed) or
     (dow == dayofweek.thursday and i_tradeThu) or
     (dow == dayofweek.friday and i_tradeFri))

// --- Combined Filters ---
allFiltersLong = canTrade and volOK and adxOK and sessionOK and dayOK and rsiSweetLong and paLongOK and (not i_useHTF or htfLongOK) and (not i_requireOB or atBullOB)
allFiltersShort = canTrade and volOK and adxOK and sessionOK and dayOK and rsiSweetShort and paShortOK and (not i_useHTF or htfShortOK) and (not i_requireOB or atBearOB)

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                                         STOP LOSS CALCULATION                                              â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

calcSL(bool isLong) =>
    sl = float(na)
    sweepBuf = atr * i_sweepBuffer

    if i_slMethod == "Structure + Sweep Buffer"
        if isLong
            sl := keyLow - sweepBuf
        else
            sl := keyHigh + sweepBuf
    else if i_slMethod == "ATR Multiple"
        sl := isLong ? close - atr * i_atrMult : close + atr * i_atrMult
    else if i_slMethod == "Fixed Pips"
        sl := isLong ? close - pipsToPrice(i_fixedSLPips) : close + pipsToPrice(i_fixedSLPips)
    else if i_slMethod == "Order Block Based"
        if isLong and not na(bullOBBot)
            sl := bullOBBot - sweepBuf
        else if not isLong and not na(bearOBTop)
            sl := bearOBTop + sweepBuf
        else
            sl := isLong ? keyLow - sweepBuf : keyHigh + sweepBuf

    // Apply min/max
    slDist = math.abs(close - sl)
    minDist = pipsToPrice(i_minSLPips)
    maxDist = pipsToPrice(i_maxSLPips)

    if slDist < minDist
        sl := isLong ? close - minDist : close + minDist
    if slDist > maxDist
        sl := isLong ? close - maxDist : close + maxDist

    sl

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                                         DYNAMIC POSITION SIZING                                            â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

calcPositionSize(float slPrice, bool isLong) =>
    // Calculate SL distance in price
    slDist = math.abs(close - slPrice)

    // Calculate SL distance in pips
    slPips = priceToPips(slDist)

    // Calculate risk amount
    riskAmount = math.min(i_accountSize * (i_riskPercent / 100), i_maxRiskDollars)

    // Calculate dollar value per pip per lot
    // For XAUUSD: 1 pip ($0.10 move) Ã— contract size (100 oz) = $10 per pip per lot
    dollarPerPipPerLot = pipSize * i_contractSize

    // Calculate position size
    // lots = Risk$ / (SL_Pips Ã— $/pip/lot)
    lots = slPips > 0 ? riskAmount / (slPips * dollarPerPipPerLot) : i_minLots

    // Apply limits
    lots := math.max(i_minLots, math.min(i_maxLots, lots))

    lots

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                                         ENTRY CONDITIONS                                                   â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

inLong = strategy.position_size > 0
inShort = strategy.position_size < 0
inPosition = inLong or inShort

structureLongOK = bias >= 0
structureShortOK = bias <= 0

longSignal = i_enableLongs and not inPosition and allFiltersLong and structureLongOK
shortSignal = i_enableShorts and not inPosition and allFiltersShort and structureShortOK

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                                         STRATEGY EXECUTION                                                 â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var float entryPrice = na
var float initialSL = na
var float currentSL = na
var float tp1 = na
var float tp2 = na
var int entryBar = na
var bool beHit = false
var bool trailActive = false
var float highSinceEntry = na
var float lowSinceEntry = na
var float positionSize = na

// --- LONG ENTRY ---
if longSignal
    entryPrice := close
    initialSL := calcSL(true)
    currentSL := initialSL
    slDist = math.abs(close - initialSL)

    tp1 := close + slDist * i_tp1RR
    tp2 := close + slDist * i_tp2RR

    positionSize := calcPositionSize(initialSL, true)
    entryBar := bar_index
    beHit := false
    trailActive := false
    highSinceEntry := close
    lowSinceEntry := close

    strategy.entry("Long", strategy.long, qty = positionSize)
    strategy.exit("LongTP1", "Long", qty_percent = i_tp1Percent, limit = tp1, stop = initialSL)
    strategy.exit("LongTP2", "Long", limit = tp2, stop = initialSL)

    dailyTrades += 1

    if i_enableAlerts
        alert("LONG @ " + str.tostring(close, "#.##") + " | Lots: " + str.tostring(positionSize, "#.##") + " | SL: " + str.tostring(initialSL, "#.##") + " | TP1: " + str.tostring(tp1, "#.##"), alert.freq_once_per_bar)

// --- SHORT ENTRY ---
if shortSignal
    entryPrice := close
    initialSL := calcSL(false)
    currentSL := initialSL
    slDist = math.abs(initialSL - close)

    tp1 := close - slDist * i_tp1RR
    tp2 := close - slDist * i_tp2RR

    positionSize := calcPositionSize(initialSL, false)
    entryBar := bar_index
    beHit := false
    trailActive := false
    highSinceEntry := close
    lowSinceEntry := close

    strategy.entry("Short", strategy.short, qty = positionSize)
    strategy.exit("ShortTP1", "Short", qty_percent = i_tp1Percent, limit = tp1, stop = initialSL)
    strategy.exit("ShortTP2", "Short", limit = tp2, stop = initialSL)

    dailyTrades += 1

    if i_enableAlerts
        alert("SHORT @ " + str.tostring(close, "#.##") + " | Lots: " + str.tostring(positionSize, "#.##") + " | SL: " + str.tostring(initialSL, "#.##") + " | TP1: " + str.tostring(tp1, "#.##"), alert.freq_once_per_bar)

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                                         BREAKEVEN & TRAILING                                               â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if inPosition
    if inLong
        highSinceEntry := math.max(nz(highSinceEntry, close), high)
    if inShort
        lowSinceEntry := math.min(nz(lowSinceEntry, close), low)

    profitPips = inLong ? close - entryPrice : entryPrice - close
    profitPercent = (profitPips / entryPrice) * 100

    // Breakeven
    if i_enableBE and not beHit and profitPercent >= i_beActivation
        beHit := true
        beLevel = inLong ? entryPrice + pipsToPrice(i_bePlusPips) : entryPrice - pipsToPrice(i_bePlusPips)
        currentSL := beLevel

        if inLong
            strategy.exit("LongBE", "Long", stop = currentSL)
        if inShort
            strategy.exit("ShortBE", "Short", stop = currentSL)

    // Trailing
    if i_enableTrail and beHit and profitPercent >= i_trailActivation
        trailActive := true
        trailDist = atr * i_trailATR

        newTrail = inLong ? highSinceEntry - trailDist : lowSinceEntry + trailDist

        if inLong and newTrail > currentSL
            currentSL := newTrail
            strategy.exit("LongTrail", "Long", stop = currentSL)
        if inShort and newTrail < currentSL
            currentSL := newTrail
            strategy.exit("ShortTrail", "Short", stop = currentSL)

// Reset on close
if not inPosition and inPosition[1]
    beHit := false
    trailActive := false
    highSinceEntry := na
    lowSinceEntry := na

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                                         VISUALS                                                            â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

plotshape(i_showEntries and longSignal, "Long", shape.triangleup, location.belowbar, color.green, size = size.normal)
plotshape(i_showEntries and shortSignal, "Short", shape.triangledown, location.abovebar, color.red, size = size.normal)

plotshape(i_showSwings and not na(swingHigh), "SwingH", shape.circle, location.abovebar, color.new(color.red, 60), size = size.tiny, offset = -swingLen)
plotshape(i_showSwings and not na(swingLow), "SwingL", shape.circle, location.belowbar, color.new(color.green, 60), size = size.tiny, offset = -swingLen)

plot(i_showSLTP ? keyLow : na, "Key Support", color.new(color.green, 70), 1, plot.style_stepline)
plot(i_showSLTP ? keyHigh : na, "Key Resistance", color.new(color.red, 70), 1, plot.style_stepline)

plot(inPosition and i_showSLTP ? currentSL : na, "SL", color.red, 2, plot.style_linebr)
plot(inPosition and i_showSLTP ? tp1 : na, "TP1", color.green, 1, plot.style_linebr)
plot(inPosition and i_showSLTP ? tp2 : na, "TP2", color.lime, 1, plot.style_linebr)
plot(inPosition and i_showSLTP ? entryPrice : na, "Entry", color.blue, 1, plot.style_linebr)

bgcolor(bias == 1 ? color.new(color.green, 95) : bias == -1 ? color.new(color.red, 95) : na)

// Info Table
if i_showTable and barstate.islast
    var table t = table.new(position.top_right, 2, 14, color.new(color.black, 80))

    table.cell(t, 0, 0, "SMC v7", text_color = color.white, text_size = size.small)
    table.cell(t, 1, 0, syminfo.ticker, text_color = color.yellow, text_size = size.small)

    table.cell(t, 0, 1, "Bias", text_color = color.white, text_size = size.tiny)
    table.cell(t, 1, 1, bias == 1 ? "BULL" : bias == -1 ? "BEAR" : "NEUT", text_color = bias == 1 ? color.green : bias == -1 ? color.red : color.gray, text_size = size.tiny)

    table.cell(t, 0, 2, "HTF", text_color = color.white, text_size = size.tiny)
    table.cell(t, 1, 2, htfBias == 1 ? "BULL" : htfBias == -1 ? "BEAR" : "NEUT", text_color = htfBias == 1 ? color.green : htfBias == -1 ? color.red : color.gray, text_size = size.tiny)

    table.cell(t, 0, 3, "RSI", text_color = color.white, text_size = size.tiny)
    table.cell(t, 1, 3, str.tostring(rsi, "#.#"), text_color = rsi > 70 ? color.red : rsi < 30 ? color.green : color.white, text_size = size.tiny)

    table.cell(t, 0, 4, "ADX", text_color = color.white, text_size = size.tiny)
    table.cell(t, 1, 4, str.tostring(adxValue, "#.#"), text_color = adxValue >= i_adxThreshold ? color.green : color.gray, text_size = size.tiny)

    table.cell(t, 0, 5, "Vol%", text_color = color.white, text_size = size.tiny)
    table.cell(t, 1, 5, str.tostring(volRatio, "#") + "%", text_color = volOK ? color.green : color.red, text_size = size.tiny)

    table.cell(t, 0, 6, "Bull OB", text_color = color.white, text_size = size.tiny)
    table.cell(t, 1, 6, atBullOB ? "YES" : "NO", text_color = atBullOB ? color.green : color.gray, text_size = size.tiny)

    table.cell(t, 0, 7, "Bear OB", text_color = color.white, text_size = size.tiny)
    table.cell(t, 1, 7, atBearOB ? "YES" : "NO", text_color = atBearOB ? color.red : color.gray, text_size = size.tiny)

    table.cell(t, 0, 8, "Position", text_color = color.white, text_size = size.tiny)
    table.cell(t, 1, 8, inLong ? "LONG" : inShort ? "SHORT" : "FLAT", text_color = inLong ? color.green : inShort ? color.red : color.gray, text_size = size.tiny)

    if i_showPosSize
        table.cell(t, 0, 9, "Lot Size", text_color = color.white, text_size = size.tiny)
        table.cell(t, 1, 9, inPosition ? str.tostring(positionSize, "#.##") : "-", text_color = color.yellow, text_size = size.tiny)

    table.cell(t, 0, 10, "BE/Trail", text_color = color.white, text_size = size.tiny)
    table.cell(t, 1, 10, beHit ? (trailActive ? "TRAIL" : "BE") : "OFF", text_color = trailActive ? color.orange : beHit ? color.green : color.gray, text_size = size.tiny)

    table.cell(t, 0, 11, "Session", text_color = color.white, text_size = size.tiny)
    table.cell(t, 1, 11, sessionOK ? "ACTIVE" : "CLOSED", text_color = sessionOK ? color.green : color.red, text_size = size.tiny)

    table.cell(t, 0, 12, "Trades", text_color = color.white, text_size = size.tiny)
    table.cell(t, 1, 12, str.tostring(dailyTrades) + "/" + str.tostring(i_maxDailyTrades), text_color = color.white, text_size = size.tiny)

    table.cell(t, 0, 13, "DD%", text_color = color.white, text_size = size.tiny)
    table.cell(t, 1, 13, str.tostring(currentDD, "#.#") + "%", text_color = currentDD > 5 ? color.red : color.green, text_size = size.tiny)

// Debug
plot(rsi, "RSI", display = display.data_window)
plot(adxValue, "ADX", display = display.data_window)
plot(volRatio, "Vol%", display = display.data_window)
plot(positionSize, "LotSize", display = display.data_window)
plot(priceToPips(math.abs(close - initialSL)), "SL Pips", display = display.data_window)

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                                              END                                                           â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
