// This Pine Scriptâ„¢ source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© XAUUSD Smart Money Concepts Trading Strategy
// Version 5.0 - Risk Management & Win Rate Optimization
// Asymmetric Long/Short rules, Strict SL enforcement, Time-based exits

//@version=6
strategy("XAUUSD SMC Strategy v5",
     overlay = true,
     pyramiding = 0,
     initial_capital = 100000,
     default_qty_type = strategy.fixed,
     default_qty_value = 1,
     commission_type = strategy.commission.cash_per_order,
     commission_value = 7,
     slippage = 3,
     process_orders_on_close = true,
     calc_on_every_tick = true,
     max_boxes_count = 500,
     max_lines_count = 500,
     max_labels_count = 500,
     use_bar_magnifier = true)

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                    MASTER CONTROL PANEL - ALL PARAMETERS                      â•‘
// â•‘            Adjust these settings for optimization and backtesting             â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ============================================================================
// GROUP 1: ACCOUNT & RISK MANAGEMENT (CRITICAL)
// ============================================================================
i_accountSize         = input.float(100000, "ğŸ’° Account Size ($)", minval = 1000, step = 1000, group = "â•â•â• 1. ACCOUNT & RISK â•â•â•", tooltip = "Your total account size in dollars")
i_riskPerTrade        = input.float(1.0, "âš ï¸ Risk Per Trade (%)", minval = 0.1, maxval = 3.0, step = 0.1, group = "â•â•â• 1. ACCOUNT & RISK â•â•â•", tooltip = "Maximum 1% recommended. This is the % of account risked per trade")
i_maxDollarLoss       = input.float(1000, "ğŸ›‘ Max Dollar Loss Per Trade ($)", minval = 100, maxval = 5000, step = 100, group = "â•â•â• 1. ACCOUNT & RISK â•â•â•", tooltip = "Hard cap on dollar loss per trade - will override other settings")
i_maxDrawdownPercent  = input.float(7.0, "ğŸ“‰ Max Account Drawdown (%)", minval = 1.0, maxval = 20.0, step = 0.5, group = "â•â•â• 1. ACCOUNT & RISK â•â•â•", tooltip = "Stop trading when account drawdown exceeds this %")
i_lotSize             = input.float(1.0, "ğŸ“Š Base Lot Size", minval = 0.01, maxval = 10.0, step = 0.01, group = "â•â•â• 1. ACCOUNT & RISK â•â•â•", tooltip = "Base lot size for position sizing calculations")
i_useRiskBasedLots    = input.bool(true, "ğŸ¯ Use Risk-Based Position Sizing", group = "â•â•â• 1. ACCOUNT & RISK â•â•â•", tooltip = "Calculate lot size based on risk % and stop distance")
i_pipValue            = input.float(10.0, "ğŸ’µ Pip Value per Lot ($)", minval = 1.0, maxval = 100.0, group = "â•â•â• 1. ACCOUNT & RISK â•â•â•", tooltip = "Dollar value per pip per standard lot for XAUUSD")

// ============================================================================
// GROUP 2: STOP LOSS SETTINGS
// ============================================================================
i_slMode              = input.string("ATR", "SL Calculation Method", options = ["ATR", "Structure", "Fixed Pips"], group = "â•â•â• 2. STOP LOSS â•â•â•", tooltip = "Method to calculate initial stop loss distance")
i_slATRMult           = input.float(1.5, "SL ATR Multiplier", minval = 0.5, maxval = 4.0, step = 0.1, group = "â•â•â• 2. STOP LOSS â•â•â•")
i_slFixedPips         = input.float(100, "SL Fixed Pips", minval = 20, maxval = 300, step = 10, group = "â•â•â• 2. STOP LOSS â•â•â•")
i_slBuffer            = input.float(10, "SL Buffer (pips)", minval = 0, maxval = 50, step = 5, group = "â•â•â• 2. STOP LOSS â•â•â•", tooltip = "Extra buffer added beyond structure levels")
i_maxSLPips           = input.float(150, "ğŸ›‘ Maximum SL Distance (pips)", minval = 50, maxval = 300, step = 10, group = "â•â•â• 2. STOP LOSS â•â•â•", tooltip = "Hard limit on stop loss distance - prevents oversized stops")
i_enforceHardSL       = input.bool(true, "ğŸ”’ Enforce Hard Stop Loss", group = "â•â•â• 2. STOP LOSS â•â•â•", tooltip = "Force close if loss exceeds max - prevents slippage through stops")

// ============================================================================
// GROUP 3: TAKE PROFIT & EXIT SETTINGS
// ============================================================================
i_tp1RR               = input.float(1.5, "TP1 Risk:Reward Ratio", minval = 0.5, maxval = 3.0, step = 0.1, group = "â•â•â• 3. TAKE PROFIT â•â•â•")
i_tp2RR               = input.float(2.5, "TP2 Risk:Reward Ratio", minval = 1.0, maxval = 5.0, step = 0.1, group = "â•â•â• 3. TAKE PROFIT â•â•â•")
i_tp1ClosePercent     = input.float(60, "TP1 Close Position %", minval = 25, maxval = 100, step = 5, group = "â•â•â• 3. TAKE PROFIT â•â•â•", tooltip = "Percentage of position to close at TP1")
i_useTrailingSL       = input.bool(true, "Enable Trailing Stop After TP1", group = "â•â•â• 3. TAKE PROFIT â•â•â•")
i_trailATRMult        = input.float(0.5, "Trailing Stop ATR Multiplier", minval = 0.2, maxval = 2.0, step = 0.1, group = "â•â•â• 3. TAKE PROFIT â•â•â•")
i_beAfterTP1          = input.bool(true, "Move to Break-Even After TP1", group = "â•â•â• 3. TAKE PROFIT â•â•â•")
i_bePlusPips          = input.float(5, "Break-Even + Pips", minval = 0, maxval = 20, step = 1, group = "â•â•â• 3. TAKE PROFIT â•â•â•")

// ============================================================================
// GROUP 4: TIME-BASED EXITS (Close losers fast, hold winners)
// ============================================================================
i_useTimeExit         = input.bool(true, "â° Enable Time-Based Exits", group = "â•â•â• 4. TIME EXITS â•â•â•", tooltip = "Close losing trades after X bars")
i_maxBarsLosing       = input.int(8, "Max Bars in Losing Trade", minval = 2, maxval = 30, step = 1, group = "â•â•â• 4. TIME EXITS â•â•â•", tooltip = "Close losing trades after this many bars")
i_maxBarsBreakeven    = input.int(15, "Max Bars at Breakeven", minval = 5, maxval = 50, step = 1, group = "â•â•â• 4. TIME EXITS â•â•â•", tooltip = "Close trades not making progress")
i_holdWinnersLonger   = input.bool(true, "Hold Profitable Trades Longer", group = "â•â•â• 4. TIME EXITS â•â•â•", tooltip = "Allow winners to run beyond time limits")
i_useEODExit          = input.bool(false, "Close Losing Trades End of Day", group = "â•â•â• 4. TIME EXITS â•â•â•")
i_eodHour             = input.int(16, "EOD Exit Hour (EST)", minval = 0, maxval = 23, group = "â•â•â• 4. TIME EXITS â•â•â•")

// ============================================================================
// GROUP 5: LONG TRADE SETTINGS (52% win rate - moderate refinement)
// ============================================================================
i_enableLongs         = input.bool(true, "âœ… Enable Long Trades", group = "â•â•â• 5. LONG TRADES â•â•â•")
i_longEntryMode       = input.string("Standard", "Long Entry Mode", options = ["Aggressive", "Standard", "Conservative"], group = "â•â•â• 5. LONG TRADES â•â•â•", tooltip = "Aggressive=fewer filters, Conservative=more confirmation")
i_longRequireHTF      = input.bool(true, "Long: Require HTF Bullish Bias", group = "â•â•â• 5. LONG TRADES â•â•â•")
i_longRequireOB       = input.bool(true, "Long: Require Order Block", group = "â•â•â• 5. LONG TRADES â•â•â•")
i_longRequireFVG      = input.bool(false, "Long: Require FVG", group = "â•â•â• 5. LONG TRADES â•â•â•")
i_longRequireSweep    = input.bool(false, "Long: Require Liquidity Sweep", group = "â•â•â• 5. LONG TRADES â•â•â•")
i_longRequireBOS      = input.bool(false, "Long: Require Recent BOS", group = "â•â•â• 5. LONG TRADES â•â•â•")
i_longRequireMomentum = input.bool(true, "Long: Require Bullish Momentum", group = "â•â•â• 5. LONG TRADES â•â•â•")
i_longTP1RR           = input.float(1.5, "Long: TP1 Risk:Reward", minval = 0.5, maxval = 3.0, step = 0.1, group = "â•â•â• 5. LONG TRADES â•â•â•")
i_longTP2RR           = input.float(2.5, "Long: TP2 Risk:Reward", minval = 1.0, maxval = 5.0, step = 0.1, group = "â•â•â• 5. LONG TRADES â•â•â•")

// ============================================================================
// GROUP 6: SHORT TRADE SETTINGS (19% win rate - STRICT REFINEMENT)
// ============================================================================
i_enableShorts        = input.bool(true, "âœ… Enable Short Trades", group = "â•â•â• 6. SHORT TRADES â•â•â•")
i_shortEntryMode      = input.string("Conservative", "Short Entry Mode", options = ["Aggressive", "Standard", "Conservative", "Very Conservative"], group = "â•â•â• 6. SHORT TRADES â•â•â•", tooltip = "Recommend Conservative or Very Conservative for shorts")
i_shortRequireHTF     = input.bool(true, "Short: Require HTF Bearish Bias", group = "â•â•â• 6. SHORT TRADES â•â•â•")
i_shortRequireOB      = input.bool(true, "Short: Require Order Block", group = "â•â•â• 6. SHORT TRADES â•â•â•")
i_shortRequireFVG     = input.bool(true, "Short: Require FVG", group = "â•â•â• 6. SHORT TRADES â•â•â•", tooltip = "Extra confirmation for shorts")
i_shortRequireSweep   = input.bool(true, "Short: Require Liquidity Sweep", group = "â•â•â• 6. SHORT TRADES â•â•â•", tooltip = "Extra confirmation for shorts")
i_shortRequireBOS     = input.bool(true, "Short: Require Recent BOS/CHoCH", group = "â•â•â• 6. SHORT TRADES â•â•â•", tooltip = "Extra confirmation for shorts")
i_shortRequireMomentum = input.bool(true, "Short: Require Bearish Momentum", group = "â•â•â• 6. SHORT TRADES â•â•â•")
i_shortRequireWeakness = input.bool(true, "Short: Require Price Weakness", group = "â•â•â• 6. SHORT TRADES â•â•â•", tooltip = "Price below key MAs")
i_shortSLMultiplier   = input.float(0.8, "Short: SL Multiplier", minval = 0.5, maxval = 1.5, step = 0.1, group = "â•â•â• 6. SHORT TRADES â•â•â•", tooltip = "Tighter stops on shorts (multiply by this)")
i_shortTP1RR          = input.float(1.2, "Short: TP1 Risk:Reward", minval = 0.5, maxval = 2.0, step = 0.1, group = "â•â•â• 6. SHORT TRADES â•â•â•", tooltip = "Take profits faster on shorts")
i_shortTP2RR          = input.float(2.0, "Short: TP2 Risk:Reward", minval = 1.0, maxval = 3.0, step = 0.1, group = "â•â•â• 6. SHORT TRADES â•â•â•")
i_shortMaxBarsLosing  = input.int(5, "Short: Max Bars Losing", minval = 2, maxval = 15, step = 1, group = "â•â•â• 6. SHORT TRADES â•â•â•", tooltip = "Faster exit on losing shorts")

// ============================================================================
// GROUP 7: STRUCTURE & HTF ANALYSIS
// ============================================================================
i_swingLength         = input.int(5, "Swing Detection Length", minval = 2, maxval = 20, group = "â•â•â• 7. STRUCTURE â•â•â•")
i_atrLength           = input.int(14, "ATR Period", minval = 5, maxval = 50, group = "â•â•â• 7. STRUCTURE â•â•â•")
i_structureLookback   = input.int(30, "Structure Lookback Bars", minval = 10, maxval = 100, group = "â•â•â• 7. STRUCTURE â•â•â•")
i_htfTimeframe        = input.timeframe("240", "HTF Timeframe", group = "â•â•â• 7. STRUCTURE â•â•â•", tooltip = "Higher timeframe for bias confirmation")
i_htfTimeframe2       = input.timeframe("D", "HTF Timeframe 2 (Daily)", group = "â•â•â• 7. STRUCTURE â•â•â•")

// ============================================================================
// GROUP 8: ORDER BLOCK SETTINGS
// ============================================================================
i_obLookback          = input.int(15, "OB Lookback Bars", minval = 5, maxval = 50, group = "â•â•â• 8. ORDER BLOCKS â•â•â•")
i_obProximity         = input.float(0.3, "OB Proximity (ATR mult)", minval = 0.1, maxval = 1.0, step = 0.1, group = "â•â•â• 8. ORDER BLOCKS â•â•â•", tooltip = "How close price must be to OB")
i_obMinSize           = input.float(0.3, "OB Min Size (ATR mult)", minval = 0.1, maxval = 1.0, step = 0.1, group = "â•â•â• 8. ORDER BLOCKS â•â•â•")
i_obRequireEngulfing  = input.bool(true, "Require Engulfing Pattern", group = "â•â•â• 8. ORDER BLOCKS â•â•â•", tooltip = "Stronger OB detection")

// ============================================================================
// GROUP 9: FVG & SWEEP SETTINGS
// ============================================================================
i_fvgMinSize          = input.float(0.2, "FVG Min Size (ATR mult)", minval = 0.1, maxval = 1.0, step = 0.1, group = "â•â•â• 9. FVG & SWEEPS â•â•â•")
i_fvgLookback         = input.int(20, "FVG Lookback Bars", minval = 5, maxval = 50, group = "â•â•â• 9. FVG & SWEEPS â•â•â•")
i_sweepLookback       = input.int(20, "Sweep Lookback Bars", minval = 5, maxval = 50, group = "â•â•â• 9. FVG & SWEEPS â•â•â•")
i_sweepConfirmBars    = input.int(5, "Sweep Confirmation Bars", minval = 1, maxval = 10, group = "â•â•â• 9. FVG & SWEEPS â•â•â•")

// ============================================================================
// GROUP 10: MOMENTUM & TREND FILTERS
// ============================================================================
i_useMomentumFilter   = input.bool(true, "Use Momentum Filter", group = "â•â•â• 10. MOMENTUM â•â•â•")
i_momentumLength      = input.int(10, "Momentum Lookback", minval = 5, maxval = 30, group = "â•â•â• 10. MOMENTUM â•â•â•")
i_momentumThreshold   = input.float(0.3, "Momentum Threshold (ATR mult)", minval = 0.1, maxval = 1.0, step = 0.1, group = "â•â•â• 10. MOMENTUM â•â•â•")
i_useTrendFilter      = input.bool(true, "Use Trend Filter", group = "â•â•â• 10. MOMENTUM â•â•â•")
i_trendMALength       = input.int(50, "Trend MA Length", minval = 20, maxval = 200, group = "â•â•â• 10. MOMENTUM â•â•â•")
i_useRSIFilter        = input.bool(true, "Use RSI Filter", group = "â•â•â• 10. MOMENTUM â•â•â•")
i_rsiLength           = input.int(14, "RSI Length", minval = 5, maxval = 30, group = "â•â•â• 10. MOMENTUM â•â•â•")
i_rsiOversold         = input.float(35, "RSI Oversold (Long)", minval = 20, maxval = 45, group = "â•â•â• 10. MOMENTUM â•â•â•")
i_rsiOverbought       = input.float(65, "RSI Overbought (Short)", minval = 55, maxval = 80, group = "â•â•â• 10. MOMENTUM â•â•â•")

// ============================================================================
// GROUP 11: SESSION & DAY FILTERS
// ============================================================================
i_useSessionFilter    = input.bool(true, "Enable Session Filter", group = "â•â•â• 11. SESSION â•â•â•")
i_sessionStart        = input.int(3, "Session Start Hour (EST)", minval = 0, maxval = 23, group = "â•â•â• 11. SESSION â•â•â•")
i_sessionEnd          = input.int(12, "Session End Hour (EST)", minval = 0, maxval = 23, group = "â•â•â• 11. SESSION â•â•â•", tooltip = "Focus on London/NY overlap")
i_useDayFilter        = input.bool(true, "Enable Day Filter", group = "â•â•â• 11. SESSION â•â•â•")
i_tradeMonday         = input.bool(false, "Trade Monday", group = "â•â•â• 11. SESSION â•â•â•", tooltip = "Mondays can be choppy")
i_tradeTuesday        = input.bool(true, "Trade Tuesday", group = "â•â•â• 11. SESSION â•â•â•")
i_tradeWednesday      = input.bool(true, "Trade Wednesday", group = "â•â•â• 11. SESSION â•â•â•")
i_tradeThursday       = input.bool(true, "Trade Thursday", group = "â•â•â• 11. SESSION â•â•â•")
i_tradeFriday         = input.bool(false, "Trade Friday", group = "â•â•â• 11. SESSION â•â•â•", tooltip = "Fridays can have unexpected moves")

// ============================================================================
// GROUP 12: EXPOSURE & DAILY LIMITS
// ============================================================================
i_maxDailyTrades      = input.int(5, "Max Trades Per Day", minval = 1, maxval = 20, group = "â•â•â• 12. EXPOSURE â•â•â•")
i_maxDailyLosses      = input.int(2, "Max Losses Per Day", minval = 1, maxval = 5, group = "â•â•â• 12. EXPOSURE â•â•â•", tooltip = "Stop trading after this many losses")
i_maxDailyLossPercent = input.float(2.0, "Max Daily Loss %", minval = 0.5, maxval = 5.0, step = 0.5, group = "â•â•â• 12. EXPOSURE â•â•â•")
i_cooldownBars        = input.int(5, "Cooldown After Loss (bars)", minval = 0, maxval = 30, group = "â•â•â• 12. EXPOSURE â•â•â•")
i_reduceOnDrawdown    = input.bool(true, "Reduce Size During Drawdown", group = "â•â•â• 12. EXPOSURE â•â•â•", tooltip = "Halve position size when in drawdown")
i_drawdownReduceAt    = input.float(3.0, "Reduce Size At Drawdown %", minval = 1.0, maxval = 10.0, step = 0.5, group = "â•â•â• 12. EXPOSURE â•â•â•")

// ============================================================================
// GROUP 13: VISUALS & ALERTS
// ============================================================================
i_showOB              = input.bool(true, "Show Order Blocks", group = "â•â•â• 13. VISUALS â•â•â•")
i_showFVG             = input.bool(true, "Show FVGs", group = "â•â•â• 13. VISUALS â•â•â•")
i_showStructure       = input.bool(true, "Show Structure Points", group = "â•â•â• 13. VISUALS â•â•â•")
i_showSignals         = input.bool(true, "Show Entry Signals", group = "â•â•â• 13. VISUALS â•â•â•")
i_showTable           = input.bool(true, "Show Info Table", group = "â•â•â• 13. VISUALS â•â•â•")
i_showRiskTable       = input.bool(true, "Show Risk Table", group = "â•â•â• 13. VISUALS â•â•â•")
i_enableAlerts        = input.bool(true, "Enable Alerts", group = "â•â•â• 13. VISUALS â•â•â•")

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                           CORE CALCULATIONS                                   â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// --- ATR and Base Calculations ---
atr = ta.atr(i_atrLength)
pipMultiplier = 10.0  // For XAUUSD, 1 pip = $0.10 movement

priceToPips(float price) => price * pipMultiplier
pipsToPrice(float pips) => pips / pipMultiplier

// --- Account Tracking ---
var float peakEquity = strategy.initial_capital
var float dailyStartEquity = strategy.initial_capital
var float currentDrawdown = 0.0
var float dailyPnL = 0.0
var int dailyTrades = 0
var int dailyLosses = 0
var int lastLossBar = 0
var int positionEntryBar = 0

// Update peak equity
if strategy.equity > peakEquity
    peakEquity := strategy.equity

// Calculate current drawdown
currentDrawdown := (peakEquity - strategy.equity) / peakEquity * 100

// New day reset
newDay = ta.change(dayofweek) != 0
if newDay
    dailyStartEquity := strategy.equity
    dailyTrades := 0
    dailyLosses := 0
    dailyPnL := 0.0

// Update daily P&L
dailyPnL := strategy.equity - dailyStartEquity

// --- Drawdown Check ---
inMaxDrawdown = currentDrawdown >= i_maxDrawdownPercent
inDailyLossLimit = (dailyPnL < 0 ? math.abs(dailyPnL) / dailyStartEquity * 100 : 0) >= i_maxDailyLossPercent
shouldReduceSize = i_reduceOnDrawdown and currentDrawdown >= i_drawdownReduceAt

// --- Position Sizing ---
calcPositionSize(float slPips, bool isShort) =>
    if not i_useRiskBasedLots
        shouldReduceSize ? i_lotSize * 0.5 : i_lotSize
    else
        riskDollars = math.min(i_accountSize * (i_riskPerTrade / 100), i_maxDollarLoss)
        if shouldReduceSize
            riskDollars := riskDollars * 0.5
        actualSlPips = slPips
        if isShort
            actualSlPips := slPips * i_shortSLMultiplier
        lots = actualSlPips > 0 ? riskDollars / (actualSlPips * i_pipValue) : i_lotSize
        math.max(0.01, math.min(10.0, lots))

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                           STRUCTURE ANALYSIS                                  â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// --- Swing Detection ---
swingHigh = ta.pivothigh(high, i_swingLength, i_swingLength)
swingLow = ta.pivotlow(low, i_swingLength, i_swingLength)

// --- Track Current Swings ---
var float currentSwingHigh = na
var float currentSwingLow = na
var int currentSwingHighBar = na
var int currentSwingLowBar = na

if not na(swingHigh)
    currentSwingHigh := swingHigh
    currentSwingHighBar := bar_index - i_swingLength

if not na(swingLow)
    currentSwingLow := swingLow
    currentSwingLowBar := bar_index - i_swingLength

// --- Market Structure Bias ---
recentHigh = ta.highest(high, i_structureLookback)
recentLow = ta.lowest(low, i_structureLookback)
midPoint = (recentHigh + recentLow) / 2
trendMA = ta.sma(close, i_trendMALength)
fastMA = ta.sma(close, 20)

var int bias = 0
if close > midPoint and close > trendMA and fastMA > trendMA
    bias := 1  // Bullish
else if close < midPoint and close < trendMA and fastMA < trendMA
    bias := -1  // Bearish
else
    bias := 0  // Neutral

// --- BOS Detection ---
var int lastBullishBOSBar = na
var int lastBearishBOSBar = na

// Bullish BOS
if not na(currentSwingHigh) and close > currentSwingHigh and close[1] <= currentSwingHigh
    lastBullishBOSBar := bar_index

// Bearish BOS
if not na(currentSwingLow) and close < currentSwingLow and close[1] >= currentSwingLow
    lastBearishBOSBar := bar_index

recentBullishBOS = not na(lastBullishBOSBar) and (bar_index - lastBullishBOSBar) <= i_structureLookback
recentBearishBOS = not na(lastBearishBOSBar) and (bar_index - lastBearishBOSBar) <= i_structureLookback

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                           HTF BIAS ANALYSIS                                   â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// HTF 4H Bias
htfClose = request.security(syminfo.tickerid, i_htfTimeframe, close, lookahead = barmerge.lookahead_off)
htfMA = request.security(syminfo.tickerid, i_htfTimeframe, ta.sma(close, 20), lookahead = barmerge.lookahead_off)
htfHighest = request.security(syminfo.tickerid, i_htfTimeframe, ta.highest(high, 20), lookahead = barmerge.lookahead_off)
htfLowest = request.security(syminfo.tickerid, i_htfTimeframe, ta.lowest(low, 20), lookahead = barmerge.lookahead_off)
htfMid = (htfHighest + htfLowest) / 2

var int htfBias = 0
if htfClose > htfMid and htfClose > htfMA
    htfBias := 1
else if htfClose < htfMid and htfClose < htfMA
    htfBias := -1
else
    htfBias := 0

// Daily Bias
dailyClose = request.security(syminfo.tickerid, i_htfTimeframe2, close, lookahead = barmerge.lookahead_off)
dailyMA = request.security(syminfo.tickerid, i_htfTimeframe2, ta.sma(close, 20), lookahead = barmerge.lookahead_off)

var int dailyBias = 0
if dailyClose > dailyMA
    dailyBias := 1
else if dailyClose < dailyMA
    dailyBias := -1
else
    dailyBias := 0

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                           ORDER BLOCK DETECTION                               â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

type OB
    float top
    float bottom
    bool isBullish
    int barIdx
    bool valid

var array<OB> bullishOBs = array.new<OB>()
var array<OB> bearishOBs = array.new<OB>()

// Detect Bullish OB (last bearish candle before bullish move)
bearishCandle = close < open
bullishCandle = close > open
strongBullish = bullishCandle and (close - open) >= atr * i_obMinSize
strongBearish = bearishCandle and (open - close) >= atr * i_obMinSize

bullishOBDetected = strongBullish and bearishCandle[1] and close > high[1]
if i_obRequireEngulfing
    bullishOBDetected := bullishOBDetected and close > open[1] and open <= close[1]

if bullishOBDetected
    newOB = OB.new(high[1], low[1], true, bar_index - 1, true)
    array.push(bullishOBs, newOB)
    if array.size(bullishOBs) > 10
        array.shift(bullishOBs)

// Detect Bearish OB (last bullish candle before bearish move)
bearishOBDetected = strongBearish and bullishCandle[1] and close < low[1]
if i_obRequireEngulfing
    bearishOBDetected := bearishOBDetected and close < open[1] and open >= close[1]

if bearishOBDetected
    newOB = OB.new(high[1], low[1], false, bar_index - 1, true)
    array.push(bearishOBs, newOB)
    if array.size(bearishOBs) > 10
        array.shift(bearishOBs)

// Check price at Order Block
priceAtBullishOB() =>
    result = false
    obBottom = float(na)
    if array.size(bullishOBs) > 0
        for i = array.size(bullishOBs) - 1 to 0
            ob = array.get(bullishOBs, i)
            age = bar_index - ob.barIdx
            if ob.valid and age <= i_obLookback
                proximity = atr * i_obProximity
                if low <= ob.top + proximity and close >= ob.bottom - proximity
                    result := true
                    obBottom := ob.bottom
                    break
    [result, obBottom]

priceAtBearishOB() =>
    result = false
    obTop = float(na)
    if array.size(bearishOBs) > 0
        for i = array.size(bearishOBs) - 1 to 0
            ob = array.get(bearishOBs, i)
            age = bar_index - ob.barIdx
            if ob.valid and age <= i_obLookback
                proximity = atr * i_obProximity
                if high >= ob.bottom - proximity and close <= ob.top + proximity
                    result := true
                    obTop := ob.top
                    break
    [result, obTop]

[atBullishOB, bullOBBottom] = priceAtBullishOB()
[atBearishOB, bearOBTop] = priceAtBearishOB()

// Invalidate mitigated OBs
if array.size(bullishOBs) > 0
    for i = array.size(bullishOBs) - 1 to 0
        ob = array.get(bullishOBs, i)
        if low < ob.bottom
            ob.valid := false

if array.size(bearishOBs) > 0
    for i = array.size(bearishOBs) - 1 to 0
        ob = array.get(bearishOBs, i)
        if high > ob.top
            ob.valid := false

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                           FVG DETECTION                                       â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

bullishFVG = low > high[2] and (low - high[2]) >= atr * i_fvgMinSize
bearishFVG = high < low[2] and (low[2] - high) >= atr * i_fvgMinSize

var float recentBullFVGTop = na
var float recentBullFVGBottom = na
var int recentBullFVGBar = na
var float recentBearFVGTop = na
var float recentBearFVGBottom = na
var int recentBearFVGBar = na

if bullishFVG
    recentBullFVGTop := low
    recentBullFVGBottom := high[2]
    recentBullFVGBar := bar_index

if bearishFVG
    recentBearFVGTop := low[2]
    recentBearFVGBottom := high
    recentBearFVGBar := bar_index

hasBullishFVG = not na(recentBullFVGBar) and (bar_index - recentBullFVGBar) <= i_fvgLookback
hasBearishFVG = not na(recentBearFVGBar) and (bar_index - recentBearFVGBar) <= i_fvgLookback

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                           LIQUIDITY SWEEP DETECTION                           â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

recentSwingHigh = ta.highest(high[1], i_sweepLookback)
recentSwingLow = ta.lowest(low[1], i_sweepLookback)

// Bullish sweep: wick below recent low, close back inside
bullishSweep = low < recentSwingLow and close > recentSwingLow and close > open

// Bearish sweep: wick above recent high, close back inside
bearishSweep = high > recentSwingHigh and close < recentSwingHigh and close < open

var int lastBullishSweepBar = na
var int lastBearishSweepBar = na

if bullishSweep
    lastBullishSweepBar := bar_index
if bearishSweep
    lastBearishSweepBar := bar_index

recentBullishSweep = not na(lastBullishSweepBar) and (bar_index - lastBullishSweepBar) <= i_sweepConfirmBars
recentBearishSweep = not na(lastBearishSweepBar) and (bar_index - lastBearishSweepBar) <= i_sweepConfirmBars

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                           MOMENTUM & TREND INDICATORS                         â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Momentum
momentum = close - close[i_momentumLength]
bullishMomentum = momentum > atr * i_momentumThreshold
bearishMomentum = momentum < -atr * i_momentumThreshold

// RSI
rsi = ta.rsi(close, i_rsiLength)
rsiLongOK = not i_useRSIFilter or rsi < i_rsiOversold or (rsi > 40 and rsi < 60 and rsi > rsi[1])
rsiShortOK = not i_useRSIFilter or rsi > i_rsiOverbought or (rsi > 40 and rsi < 60 and rsi < rsi[1])

// Trend
aboveTrendMA = close > trendMA
belowTrendMA = close < trendMA
trendLongOK = not i_useTrendFilter or aboveTrendMA
trendShortOK = not i_useTrendFilter or belowTrendMA

// Price weakness for shorts (price below multiple MAs)
ema20 = ta.ema(close, 20)
ema50 = ta.ema(close, 50)
priceWeakness = close < ema20 and close < ema50 and ema20 < ema50

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                           SESSION & DAY FILTERS                               â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

currentHour = hour(time, "America/New_York")
inSession = not i_useSessionFilter or (currentHour >= i_sessionStart and currentHour < i_sessionEnd)

currentDay = dayofweek(time)
validDay = not i_useDayFilter or (
     (currentDay == dayofweek.monday and i_tradeMonday) or
     (currentDay == dayofweek.tuesday and i_tradeTuesday) or
     (currentDay == dayofweek.wednesday and i_tradeWednesday) or
     (currentDay == dayofweek.thursday and i_tradeThursday) or
     (currentDay == dayofweek.friday and i_tradeFriday)
)

// Exposure checks
canTradeExposure = dailyTrades < i_maxDailyTrades and dailyLosses < i_maxDailyLosses
notInCooldown = bar_index >= lastLossBar + i_cooldownBars

// Combined filters
filtersPass = inSession and validDay and canTradeExposure and notInCooldown and not inMaxDrawdown and not inDailyLossLimit

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                           ENTRY CONDITIONS                                    â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

inLong = strategy.position_size > 0
inShort = strategy.position_size < 0
inPosition = inLong or inShort

// === LONG ENTRY CONDITIONS ===
longHTFOK = not i_longRequireHTF or (htfBias >= 0 and dailyBias >= 0)
longOBOK = not i_longRequireOB or atBullishOB
longFVGOK = not i_longRequireFVG or hasBullishFVG
longSweepOK = not i_longRequireSweep or recentBullishSweep
longBOSOK = not i_longRequireBOS or recentBullishBOS
longMomentumOK = not i_longRequireMomentum or bullishMomentum

longStructureOK = bias >= 0 or recentBullishBOS
longConfirmCandle = close > open and close > (high + low) / 2

longBaseCondition = i_enableLongs and filtersPass and not inPosition and longStructureOK

longSignal = switch i_longEntryMode
    "Aggressive" => longBaseCondition and longOBOK
    "Standard" => longBaseCondition and longHTFOK and longOBOK and longConfirmCandle
    "Conservative" => longBaseCondition and longHTFOK and longOBOK and longMomentumOK and longConfirmCandle and trendLongOK
    => longBaseCondition

// === SHORT ENTRY CONDITIONS (STRICTER) ===
shortHTFOK = not i_shortRequireHTF or (htfBias <= 0 and dailyBias <= 0)
shortOBOK = not i_shortRequireOB or atBearishOB
shortFVGOK = not i_shortRequireFVG or hasBearishFVG
shortSweepOK = not i_shortRequireSweep or recentBearishSweep
shortBOSOK = not i_shortRequireBOS or recentBearishBOS
shortMomentumOK = not i_shortRequireMomentum or bearishMomentum
shortWeaknessOK = not i_shortRequireWeakness or priceWeakness

shortStructureOK = bias <= 0 or recentBearishBOS
shortConfirmCandle = close < open and close < (high + low) / 2

shortBaseCondition = i_enableShorts and filtersPass and not inPosition and shortStructureOK

shortSignal = switch i_shortEntryMode
    "Aggressive" => shortBaseCondition and shortOBOK
    "Standard" => shortBaseCondition and shortHTFOK and shortOBOK and shortConfirmCandle
    "Conservative" => shortBaseCondition and shortHTFOK and shortOBOK and shortFVGOK and shortMomentumOK and shortConfirmCandle and trendShortOK
    "Very Conservative" => shortBaseCondition and shortHTFOK and shortOBOK and shortFVGOK and shortSweepOK and shortBOSOK and shortMomentumOK and shortWeaknessOK and shortConfirmCandle and trendShortOK and rsiShortOK
    => shortBaseCondition

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                           STOP LOSS CALCULATION                               â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

calcStopLoss(bool isLong, bool isShort) =>
    sl = float(na)

    if i_slMode == "ATR"
        slDist = atr * i_slATRMult
        if isShort
            slDist := slDist * i_shortSLMultiplier
        sl := isLong ? close - slDist : close + slDist
    else if i_slMode == "Structure"
        buffer = pipsToPrice(i_slBuffer)
        if isLong
            structSL = not na(currentSwingLow) ? currentSwingLow - buffer : close - atr * 1.5
            obSL = atBullishOB and not na(bullOBBottom) ? bullOBBottom - buffer : structSL
            sl := math.min(structSL, obSL)
        else
            structSL = not na(currentSwingHigh) ? currentSwingHigh + buffer : close + atr * 1.5
            obSL = atBearishOB and not na(bearOBTop) ? bearOBTop + buffer : structSL
            sl := math.max(structSL, obSL)
            // Apply short SL multiplier (tighter)
            slDist = math.abs(close - sl) * i_shortSLMultiplier
            sl := close + slDist
    else  // Fixed Pips
        slPips = i_slFixedPips
        if isShort
            slPips := slPips * i_shortSLMultiplier
        sl := isLong ? close - pipsToPrice(slPips) : close + pipsToPrice(slPips)

    // Enforce maximum SL distance
    maxSLDist = pipsToPrice(i_maxSLPips)
    if isLong and (close - sl) > maxSLDist
        sl := close - maxSLDist
    if isShort and (sl - close) > maxSLDist
        sl := close + maxSLDist

    sl

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                           STRATEGY EXECUTION                                  â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var float entryPrice = na
var float stopLoss = na
var float takeProfit1 = na
var float takeProfit2 = na
var bool isCurrentLong = false

// --- LONG ENTRY ---
if longSignal
    entryPrice := close
    stopLoss := calcStopLoss(true, false)
    slDist = math.abs(close - stopLoss)

    // Use long-specific RR ratios
    takeProfit1 := close + slDist * i_longTP1RR
    takeProfit2 := close + slDist * i_longTP2RR

    slPips = priceToPips(slDist)
    lots = calcPositionSize(slPips, false)

    isCurrentLong := true
    positionEntryBar := bar_index

    strategy.entry("Long", strategy.long, qty = lots)
    strategy.exit("Long TP1", "Long", qty_percent = i_tp1ClosePercent, limit = takeProfit1, stop = stopLoss)
    strategy.exit("Long TP2", "Long", limit = takeProfit2, stop = stopLoss)

    dailyTrades += 1

    if i_enableAlerts
        alert("LONG Entry @ " + str.tostring(close) + " | SL: " + str.tostring(stopLoss) + " | TP1: " + str.tostring(takeProfit1), alert.freq_once_per_bar)

// --- SHORT ENTRY ---
if shortSignal
    entryPrice := close
    stopLoss := calcStopLoss(false, true)
    slDist = math.abs(stopLoss - close)

    // Use short-specific RR ratios (faster TP)
    takeProfit1 := close - slDist * i_shortTP1RR
    takeProfit2 := close - slDist * i_shortTP2RR

    slPips = priceToPips(slDist)
    lots = calcPositionSize(slPips, true)

    isCurrentLong := false
    positionEntryBar := bar_index

    strategy.entry("Short", strategy.short, qty = lots)
    strategy.exit("Short TP1", "Short", qty_percent = i_tp1ClosePercent, limit = takeProfit1, stop = stopLoss)
    strategy.exit("Short TP2", "Short", limit = takeProfit2, stop = stopLoss)

    dailyTrades += 1

    if i_enableAlerts
        alert("SHORT Entry @ " + str.tostring(close) + " | SL: " + str.tostring(stopLoss) + " | TP1: " + str.tostring(takeProfit1), alert.freq_once_per_bar)

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                           TIME-BASED & HARD EXITS                             â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

barsInTrade = bar_index - positionEntryBar
currentPnL = inLong ? close - entryPrice : inShort ? entryPrice - close : 0.0
isLosing = currentPnL < 0
isBreakeven = math.abs(currentPnL) < atr * 0.2
isProfitable = currentPnL > 0

// Time-based exit conditions
maxBarsForThisTrade = inShort ? i_shortMaxBarsLosing : i_maxBarsLosing
shouldTimeExitLosing = i_useTimeExit and isLosing and barsInTrade >= maxBarsForThisTrade
shouldTimeExitBreakeven = i_useTimeExit and isBreakeven and barsInTrade >= i_maxBarsBreakeven
shouldTimeExit = shouldTimeExitLosing or (shouldTimeExitBreakeven and not i_holdWinnersLonger)

// EOD exit for losing trades
isEODExit = i_useEODExit and hour(time, "America/New_York") >= i_eodHour and isLosing

// Hard stop loss enforcement - close if loss exceeds max dollar
currentDollarLoss = inPosition ? math.abs(currentPnL) * (inLong or inShort ? math.abs(strategy.position_size) : 0) * i_pipValue / pipMultiplier : 0.0
shouldHardExit = i_enforceHardSL and currentDollarLoss > i_maxDollarLoss

// Execute time/hard exits
if inPosition and (shouldTimeExit or isEODExit or shouldHardExit)
    exitReason = shouldHardExit ? "Hard SL" : shouldTimeExitLosing ? "Time Exit (Losing)" : isEODExit ? "EOD Exit" : "Time Exit (BE)"

    if inLong
        strategy.close("Long", comment = exitReason)
    if inShort
        strategy.close("Short", comment = exitReason)

    if i_enableAlerts
        alert(exitReason + " @ " + str.tostring(close), alert.freq_once_per_bar)

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                           TRAILING STOP MANAGEMENT                            â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var bool tp1Hit = false
var float trailingSL = na

if inLong
    // Detect TP1 hit (position reduced)
    if strategy.position_size < strategy.position_size[1] and strategy.position_size > 0
        tp1Hit := true
        if i_beAfterTP1
            trailingSL := entryPrice + pipsToPrice(i_bePlusPips)

    // Update trailing stop
    if tp1Hit and i_useTrailingSL
        newTrailSL = low[1] - atr * i_trailATRMult
        if na(trailingSL) or newTrailSL > trailingSL
            trailingSL := newTrailSL
            strategy.exit("Long Trail", "Long", stop = trailingSL)

if inShort
    if strategy.position_size > strategy.position_size[1] and strategy.position_size < 0
        tp1Hit := true
        if i_beAfterTP1
            trailingSL := entryPrice - pipsToPrice(i_bePlusPips)

    if tp1Hit and i_useTrailingSL
        newTrailSL = high[1] + atr * i_trailATRMult
        if na(trailingSL) or newTrailSL < trailingSL
            trailingSL := newTrailSL
            strategy.exit("Short Trail", "Short", stop = trailingSL)

// Reset on position close
if not inPosition and inPosition[1]
    tp1Hit := false
    trailingSL := na

// Track losses for cooldown
if not inPosition and inPosition[1]
    if strategy.closedtrades > 0
        lastProfit = strategy.closedtrades.profit(strategy.closedtrades - 1)
        if lastProfit < 0
            dailyLosses += 1
            lastLossBar := bar_index

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                           VISUALS & INFO TABLES                               â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Entry signals
plotshape(i_showSignals and longSignal, title = "Long Signal", style = shape.triangleup, location = location.belowbar, color = color.green, size = size.normal)
plotshape(i_showSignals and shortSignal, title = "Short Signal", style = shape.triangledown, location = location.abovebar, color = color.red, size = size.normal)

// Structure
plotshape(i_showStructure and not na(swingHigh), title = "Swing High", style = shape.circle, location = location.abovebar, color = color.new(color.red, 50), size = size.tiny, offset = -i_swingLength)
plotshape(i_showStructure and not na(swingLow), title = "Swing Low", style = shape.circle, location = location.belowbar, color = color.new(color.green, 50), size = size.tiny, offset = -i_swingLength)

// Bias background
bgColor = bias == 1 ? color.new(color.green, 95) : bias == -1 ? color.new(color.red, 95) : na
bgcolor(bgColor, title = "Bias Background")

// Stop loss and TP lines when in position
plot(inPosition ? stopLoss : na, title = "Stop Loss", color = color.red, style = plot.style_linebr, linewidth = 2)
plot(inPosition ? takeProfit1 : na, title = "TP1", color = color.green, style = plot.style_linebr, linewidth = 1)
plot(inPosition ? takeProfit2 : na, title = "TP2", color = color.lime, style = plot.style_linebr, linewidth = 1)
plot(inPosition and tp1Hit ? trailingSL : na, title = "Trailing SL", color = color.orange, style = plot.style_linebr, linewidth = 2)

// Info Table
if i_showTable and barstate.islast
    var table infoTable = table.new(position.top_right, 2, 10, bgcolor = color.new(color.black, 80))

    table.cell(infoTable, 0, 0, "SMC Strategy v5", text_color = color.white, text_size = size.small)
    table.cell(infoTable, 1, 0, syminfo.ticker, text_color = color.yellow, text_size = size.small)

    biasText = bias == 1 ? "BULLISH" : bias == -1 ? "BEARISH" : "NEUTRAL"
    biasColor = bias == 1 ? color.green : bias == -1 ? color.red : color.gray
    table.cell(infoTable, 0, 1, "LTF Bias", text_color = color.white, text_size = size.tiny)
    table.cell(infoTable, 1, 1, biasText, text_color = biasColor, text_size = size.tiny)

    htfText = htfBias == 1 ? "BULLISH" : htfBias == -1 ? "BEARISH" : "NEUTRAL"
    htfColor = htfBias == 1 ? color.green : htfBias == -1 ? color.red : color.gray
    table.cell(infoTable, 0, 2, "HTF Bias", text_color = color.white, text_size = size.tiny)
    table.cell(infoTable, 1, 2, htfText, text_color = htfColor, text_size = size.tiny)

    table.cell(infoTable, 0, 3, "At Bull OB", text_color = color.white, text_size = size.tiny)
    table.cell(infoTable, 1, 3, atBullishOB ? "YES" : "NO", text_color = atBullishOB ? color.green : color.gray, text_size = size.tiny)

    table.cell(infoTable, 0, 4, "At Bear OB", text_color = color.white, text_size = size.tiny)
    table.cell(infoTable, 1, 4, atBearishOB ? "YES" : "NO", text_color = atBearishOB ? color.red : color.gray, text_size = size.tiny)

    posText = inLong ? "LONG" : inShort ? "SHORT" : "FLAT"
    posColor = inLong ? color.green : inShort ? color.red : color.gray
    table.cell(infoTable, 0, 5, "Position", text_color = color.white, text_size = size.tiny)
    table.cell(infoTable, 1, 5, posText, text_color = posColor, text_size = size.tiny)

    table.cell(infoTable, 0, 6, "Trades Today", text_color = color.white, text_size = size.tiny)
    table.cell(infoTable, 1, 6, str.tostring(dailyTrades) + "/" + str.tostring(i_maxDailyTrades), text_color = color.white, text_size = size.tiny)

    table.cell(infoTable, 0, 7, "Losses Today", text_color = color.white, text_size = size.tiny)
    table.cell(infoTable, 1, 7, str.tostring(dailyLosses) + "/" + str.tostring(i_maxDailyLosses), text_color = dailyLosses > 0 ? color.orange : color.white, text_size = size.tiny)

    table.cell(infoTable, 0, 8, "Filters", text_color = color.white, text_size = size.tiny)
    table.cell(infoTable, 1, 8, filtersPass ? "PASS" : "BLOCKED", text_color = filtersPass ? color.green : color.red, text_size = size.tiny)

    table.cell(infoTable, 0, 9, "Session", text_color = color.white, text_size = size.tiny)
    table.cell(infoTable, 1, 9, inSession ? "ACTIVE" : "CLOSED", text_color = inSession ? color.green : color.gray, text_size = size.tiny)

// Risk Table
if i_showRiskTable and barstate.islast
    var table riskTable = table.new(position.bottom_right, 2, 7, bgcolor = color.new(color.black, 80))

    table.cell(riskTable, 0, 0, "â•â•â• RISK STATUS â•â•â•", text_color = color.yellow, text_size = size.small)
    table.cell(riskTable, 1, 0, "", text_color = color.white, text_size = size.small)

    table.cell(riskTable, 0, 1, "Account Drawdown", text_color = color.white, text_size = size.tiny)
    ddColor = currentDrawdown > 5 ? color.red : currentDrawdown > 3 ? color.orange : color.green
    table.cell(riskTable, 1, 1, str.tostring(currentDrawdown, "#.##") + "%", text_color = ddColor, text_size = size.tiny)

    table.cell(riskTable, 0, 2, "Max Drawdown", text_color = color.white, text_size = size.tiny)
    table.cell(riskTable, 1, 2, str.tostring(i_maxDrawdownPercent) + "%", text_color = color.gray, text_size = size.tiny)

    table.cell(riskTable, 0, 3, "Daily P&L", text_color = color.white, text_size = size.tiny)
    pnlColor = dailyPnL >= 0 ? color.green : color.red
    table.cell(riskTable, 1, 3, "$" + str.tostring(dailyPnL, "#.##"), text_color = pnlColor, text_size = size.tiny)

    table.cell(riskTable, 0, 4, "Risk Per Trade", text_color = color.white, text_size = size.tiny)
    table.cell(riskTable, 1, 4, str.tostring(i_riskPerTrade) + "% / $" + str.tostring(i_maxDollarLoss), text_color = color.white, text_size = size.tiny)

    table.cell(riskTable, 0, 5, "Position Size", text_color = color.white, text_size = size.tiny)
    sizeText = shouldReduceSize ? "REDUCED" : "NORMAL"
    sizeColor = shouldReduceSize ? color.orange : color.green
    table.cell(riskTable, 1, 5, sizeText, text_color = sizeColor, text_size = size.tiny)

    statusText = inMaxDrawdown ? "MAX DD HIT" : inDailyLossLimit ? "DAILY LIMIT" : "TRADING OK"
    statusColor = (inMaxDrawdown or inDailyLossLimit) ? color.red : color.green
    table.cell(riskTable, 0, 6, "Status", text_color = color.white, text_size = size.tiny)
    table.cell(riskTable, 1, 6, statusText, text_color = statusColor, text_size = size.tiny)

// Debug plots (data window only)
plot(atBullishOB ? 1 : 0, title = "At Bullish OB", display = display.data_window)
plot(atBearishOB ? 1 : 0, title = "At Bearish OB", display = display.data_window)
plot(recentBullishBOS ? 1 : 0, title = "Recent Bull BOS", display = display.data_window)
plot(recentBearishBOS ? 1 : 0, title = "Recent Bear BOS", display = display.data_window)
plot(bullishMomentum ? 1 : bearishMomentum ? -1 : 0, title = "Momentum", display = display.data_window)
plot(rsi, title = "RSI", display = display.data_window)
plot(currentDrawdown, title = "Drawdown %", display = display.data_window)
plot(barsInTrade, title = "Bars In Trade", display = display.data_window)

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                                    END                                        â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
